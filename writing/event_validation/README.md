# Event Validation - Refactored Plot Generation

This directory contains the refactored and modularized version of the original `plots.R` script. The code has been broken down into logical modules that are easier to maintain and understand.

## File Structure

### Core Modules
- **`01_data_loading.R`** - Data loading and preparation functions
- **`02_plotting_functions.R`** - Reusable plotting functions with shock point overlays
- **`03_regional_plots.R`** - Regional plot generation (normalized counts with shock points)
- **`04_country_plots.R`** - Country-specific plot generation (coups, elections, Guatemala analysis)

### Execution
- **`generate_all_plots.R`** - Main script to generate all plots

### Legacy
- **`plots.R`** - Original 4000+ line script (kept for reference)

## Key Improvements

### 1. Data Source Updates
- Uses new data structure from `data/final-counts/`
- Leverages existing normalized variables (suffix `Norm`)
- Uses `constants.R` for region mappings
- No longer requires external Dropbox data

### 2. Code Reduction
- **Before**: 4000+ lines of duplicated code
- **After**: ~500 lines across modular files
- Eliminated hundreds of lines of copy-paste code

### 3. Maintainability
- Functions replace repetitive code blocks
- Region mappings from `constants.R` (single source of truth)
- Consistent variable naming
- Clear separation of concerns

### 4. Functionality
- **Identical output** to original script
- Properly structured coup plots (line + points + vertical lines)
- Country-specific date ranges and coup/attempt distinctions
- Standardized plot styling with bold titles
- Error handling and progress reporting
- Flexible execution options

### 5. Plot Structure Accuracy
- **Regional plots**: Normalized counts with red shock points overlaid
- **Coup plots**: Civic data as line, shock points overlaid, event-specific vertical lines with colors
- **Election plots**: Individual plots with legends, combined regional plots by specific countries
- **Date ranges**: Match original script exactly for each country
- **Event distinctions**: Coup vs attempt vs self-coup with different colors (red/blue/orange)

## Usage

### Generate All Plots
```r
source("writing/event_validation/generate_all_plots.R")
```

### Generate Specific Plot Types
```r
# Load modules
source("writing/event_validation/01_data_loading.R")
source("writing/event_validation/03_regional_plots.R")

# Generate only regional plots with shock points
generate_all_regional_plots("output/directory")
```

### Custom Plot Generation
```r
# Load required modules
source("writing/event_validation/01_data_loading.R")
source("writing/event_validation/02_plotting_functions.R")

# Load data
data_list <- load_all_data()

# Create custom election plot
plot <- create_election_plot(
  shock_data = data_list$shock_data,
  civic_data = data_list$civic_data,
  country_name = "Colombia",
  date_range = c("2021-01-01", "2023-01-01"),
  election_events = data.frame(
    dates = as.Date(c("2022-03-01", "2022-05-01")),
    labels = c("Congressional Elections", "Presidential Election")
  )
)
```

## Generated Outputs

The scripts generate the same plots as the original:

### Regional Plots
- `Normalized_Martiallaw_[Region].png` - Normalized martial law counts with shock points
- `Normalized_Activism_[Region].png` - Normalized activism counts with shock points

### Country-Specific Plots  
- Individual coup plots: `Coup_[Country].png` for countries with coups since 2017
- `Combined_Coup_Plots.png` - Grid of all coup analysis plots
- Election plots: `Election_[Country].png` for countries with detailed election data
- `Combined_elections_LAC.png` / `Combined_elections_EAP.png` - Regional election grids

### Special Analysis
- `Combined_GTM2023_Plots.png` - Guatemala 2023 4-panel analysis
- `Guatemala_2015_Analysis.png` - Guatemala 2015 specific analysis

## Dependencies

The refactored code requires the following R packages:
- `dplyr`
- `ggplot2` 
- `scales`
- `patchwork`
- `stringr`
- `here`
- `purrr`

All dependencies should already be available if the original script worked.

## Data Requirements

The code expects the following data files to exist:
- `data/final-counts/shock-civic-data.csv`
- `data/final-counts/full-civic-data.csv`
- `build_data/constants.R`

These should be generated by running the main data construction pipeline (`build_data/build_data.R`).