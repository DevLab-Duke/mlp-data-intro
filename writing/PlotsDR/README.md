# PlotsDR - Refactored Plot Generation

This directory contains the refactored and modularized version of the original `plots.R` script. The code has been broken down into logical modules that are easier to maintain and understand.

## File Structure

### Core Modules
- **`01_data_loading.R`** - Data loading and preparation functions
- **`02_plotting_functions.R`** - Reusable plotting functions
- **`03_regional_plots.R`** - Regional plot generation
- **`04_country_plots.R`** - Country-specific plot generation

### Execution
- **`generate_all_plots.R`** - Main script to generate all plots

### Legacy
- **`plots.R`** - Original 4000+ line script (kept for reference)

## Key Improvements

### 1. Data Source Updates
- Uses new data structure from `data/final-counts/`
- Leverages existing normalized variables (suffix `Norm`)
- Uses `constants.R` for region mappings
- No longer requires external Dropbox data

### 2. Code Reduction
- **Before**: 4000+ lines of duplicated code
- **After**: ~500 lines across modular files
- Eliminated hundreds of lines of copy-paste code

### 3. Maintainability
- Functions replace repetitive code blocks
- Region mappings from `constants.R` (single source of truth)
- Consistent variable naming
- Clear separation of concerns

### 4. Functionality
- **Identical output** to original script
- Properly structured coup plots (line + points + vertical lines)
- Country-specific date ranges and coup/attempt distinctions
- Standardized plot styling
- Error handling and progress reporting
- Flexible execution options

### 5. Plot Structure Accuracy
- **Regional plots**: Use shock data normalized values
- **Coup plots**: Civic data as line, shock points overlaid, event-specific vertical lines
- **Date ranges**: Match original script exactly for each country
- **Event distinctions**: Coup vs attempt with different colors

## Usage

### Generate All Plots
```r
source("writing/PlotsDR/generate_all_plots.R")
```

### Generate Specific Plot Types
```r
# Load modules
source("writing/PlotsDR/01_data_loading.R")
source("writing/PlotsDR/03_regional_plots.R")

# Generate only regional plots
generate_all_regional_plots("output/directory")
```

### Custom Plot Generation
```r
# Load required modules
source("writing/PlotsDR/01_data_loading.R")
source("writing/PlotsDR/02_plotting_functions.R")

# Load data
data_list <- load_all_data()

# Create custom plot
plot <- create_regional_shock_plot(
  data = data_list$shock_data,
  event_var = "coup",
  region_name = "Sub-Saharan Africa"
)
```

## Generated Outputs

The scripts generate the same plots as the original:

### Regional Plots
- Martial law shock plots by region
- Normalized count plots by region and event type

### Country-Specific Plots  
- Coup analysis plots for countries with coups since 2017
- Election activity plots by region
- Guatemala 2015 specific analysis

### Combined Plots
- Grid plots combining multiple countries by region
- Comparative visualizations

## Dependencies

The refactored code requires the following R packages:
- `dplyr`
- `ggplot2` 
- `scales`
- `patchwork`
- `stringr`
- `here`
- `purrr`

All dependencies should already be available if the original script worked.

## Data Requirements

The code expects the following data files to exist:
- `data/final-counts/shock-civic-data.csv`
- `data/final-counts/full-civic-data.csv`
- `build_data/constants.R`

These should be generated by running the main data construction pipeline (`build_data/build_data.R`).